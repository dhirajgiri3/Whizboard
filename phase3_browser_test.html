<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 3 Feature Tests - WhizBoard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #0A0A0B;
            color: #FFFFFF;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            background: #111111;
            border: 1px solid #262626;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #60A5FA;
        }
        
        .test-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #171717;
            border-radius: 8px;
            border-left: 4px solid #262626;
        }
        
        .test-item.pass {
            border-left-color: #10B981;
        }
        
        .test-item.fail {
            border-left-color: #EF4444;
        }
        
        .test-item.running {
            border-left-color: #F59E0B;
        }
        
        .test-status {
            margin-right: 10px;
            font-weight: bold;
        }
        
        .test-name {
            flex: 1;
        }
        
        .test-details {
            color: #A3A3A3;
            font-size: 0.9em;
        }
        
        .summary {
            background: #111111;
            border: 1px solid #262626;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .summary h3 {
            margin: 0 0 15px 0;
            color: #60A5FA;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat {
            background: #171717;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #60A5FA;
        }
        
        .stat-label {
            color: #A3A3A3;
            font-size: 0.9em;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        
        button {
            background: #2563EB;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 5px;
        }
        
        button:hover {
            background: #1D4ED8;
        }
        
        button:disabled {
            background: #374151;
            cursor: not-allowed;
        }
        
        .progress {
            background: #171717;
            border-radius: 8px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            background: #60A5FA;
            height: 100%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 Phase 3 Feature Tests</h1>
            <p>Testing Export/Import & File Management Features</p>
        </div>
        
        <div class="controls">
            <button id="runTests">Run All Tests</button>
            <button id="clearResults">Clear Results</button>
        </div>
        
        <div class="progress">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
        
        <div id="testResults">
            <!-- Test results will be populated here -->
        </div>
        
        <div class="summary" id="summary" style="display: none;">
            <h3>📊 Test Summary</h3>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="totalTests">0</div>
                    <div class="stat-label">Total Tests</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="passedTests">0</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="failedTests">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="successRate">0%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Test Configuration
        const TEST_CONFIG = {
            baseUrl: window.location.origin,
            testBoardId: '688b5a63e2438f87ecc4f818', // Real board ID from logs
            testFiles: {
                png: 'test-image.png',
                jpg: 'test-image.jpg',
                svg: 'test-image.svg',
                json: 'test-board.json'
            }
        };

        // Test Results Tracking
        const testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            errors: []
        };

        // Test Definitions
        const tests = [
            // Export Tests
            {
                category: 'Export Features',
                name: 'Basic PNG Export',
                test: async () => {
                    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/board/${TEST_CONFIG.testBoardId}/export?format=png&resolution=1x&background=transparent`);
                    if (response.ok) {
                        const blob = await response.blob();
                        return blob.type === 'image/png' ? 
                            { success: true, details: `File size: ${blob.size} bytes` } :
                            { success: false, details: 'Incorrect file type' };
                    }
                    return { success: false, details: `HTTP ${response.status}` };
                }
            },
            {
                category: 'Export Features',
                name: 'PNG Resolution Options',
                test: async () => {
                    const resolutions = ['1x', '2x', '4x'];
                    let allPassed = true;
                    const details = [];
                    
                    for (const resolution of resolutions) {
                        try {
                            const response = await fetch(`${TEST_CONFIG.baseUrl}/api/board/${TEST_CONFIG.testBoardId}/export?format=png&resolution=${resolution}`);
                            if (response.ok) {
                                const blob = await response.blob();
                                details.push(`${resolution}: ${blob.size} bytes`);
                            } else {
                                allPassed = false;
                                details.push(`${resolution}: HTTP ${response.status}`);
                            }
                        } catch (error) {
                            allPassed = false;
                            details.push(`${resolution}: ${error.message}`);
                        }
                    }
                    
                    return { 
                        success: allPassed, 
                        details: details.join(', ') 
                    };
                }
            },
            {
                category: 'Export Features',
                name: 'Basic SVG Export',
                test: async () => {
                    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/board/${TEST_CONFIG.testBoardId}/export?format=svg`);
                    if (response.ok) {
                        const text = await response.text();
                        return text.includes('<svg') && text.includes('</svg>') ?
                            { success: true, details: 'Valid SVG structure' } :
                            { success: false, details: 'Invalid SVG structure' };
                    }
                    return { success: false, details: `HTTP ${response.status}` };
                }
            },
            {
                category: 'Export Features',
                name: 'Basic JSON Export',
                test: async () => {
                    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/board/${TEST_CONFIG.testBoardId}/export?format=json`);
                    if (response.ok) {
                        const data = await response.json();
                        return data.id && data.elements ?
                            { success: true, details: `Board with ${data.elements.length} elements` } :
                            { success: false, details: 'Invalid JSON structure' };
                    }
                    return { success: false, details: `HTTP ${response.status}` };
                }
            },
            
            // Import Tests
            {
                category: 'Import Features',
                name: 'Image Import',
                test: async () => {
                    const mockImageBlob = new Blob(['fake image data'], { type: 'image/png' });
                    const formData = new FormData();
                    formData.append('file', mockImageBlob, 'test-image.png');
                    formData.append('type', 'image');
                    formData.append('options', JSON.stringify({ scale: 1, position: 'center' }));
                    
                    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/board/${TEST_CONFIG.testBoardId}/import`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    return response.ok ?
                        { success: true, details: 'Image imported successfully' } :
                        { success: false, details: `HTTP ${response.status}` };
                }
            },
            {
                category: 'Import Features',
                name: 'JSON Import',
                test: async () => {
                    const mockJsonData = {
                        version: '1.0',
                        elements: [{ id: '1', type: 'text', data: { text: 'Test' }, style: {} }]
                    };
                    
                    const mockJsonBlob = new Blob([JSON.stringify(mockJsonData)], { type: 'application/json' });
                    const formData = new FormData();
                    formData.append('file', mockJsonBlob, 'test-board.json');
                    formData.append('type', 'json');
                    formData.append('options', JSON.stringify({ merge: true }));
                    
                    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/board/${TEST_CONFIG.testBoardId}/import`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    return response.ok ?
                        { success: true, details: 'JSON imported successfully' } :
                        { success: false, details: `HTTP ${response.status}` };
                }
            },
            {
                category: 'Import Features',
                name: 'Template Import',
                test: async () => {
                    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/board/${TEST_CONFIG.testBoardId}/import?type=templates`);
                    if (response.ok) {
                        const templates = await response.json();
                        return Array.isArray(templates) ?
                            { success: true, details: `${templates.length} templates available` } :
                            { success: false, details: 'Invalid template response' };
                    }
                    return { success: false, details: `HTTP ${response.status}` };
                }
            },
            
            // File Management Tests
            {
                category: 'File Management',
                name: 'File List',
                test: async () => {
                    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/board/${TEST_CONFIG.testBoardId}/files`);
                    if (response.ok) {
                        const files = await response.json();
                        return Array.isArray(files) ?
                            { success: true, details: `${files.length} files found` } :
                            { success: false, details: 'Invalid file list response' };
                    }
                    return { success: false, details: `HTTP ${response.status}` };
                }
            },
            {
                category: 'File Management',
                name: 'File Upload',
                test: async () => {
                    const mockFileBlob = new Blob(['test file content'], { type: 'text/plain' });
                    const formData = new FormData();
                    formData.append('file', mockFileBlob, 'test-file.txt');
                    formData.append('name', 'Test File');
                    formData.append('description', 'Test file for upload');
                    formData.append('tags', 'test,upload');
                    
                    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/board/${TEST_CONFIG.testBoardId}/files`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    return response.ok ?
                        { success: true, details: 'File uploaded successfully' } :
                        { success: false, details: `HTTP ${response.status}` };
                }
            },
            {
                category: 'File Management',
                name: 'File Search',
                test: async () => {
                    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/board/${TEST_CONFIG.testBoardId}/files?search=test`);
                    if (response.ok) {
                        const files = await response.json();
                        return { success: true, details: `Search returned ${files.length} results` };
                    }
                    return { success: false, details: `HTTP ${response.status}` };
                }
            },
            
            // Error Handling Tests
            {
                category: 'Error Handling',
                name: 'Invalid Board ID',
                test: async () => {
                    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/board/invalid-id/export`);
                    return response.status === 404 ?
                        { success: true, details: 'Proper 404 error returned' } :
                        { success: false, details: `Expected 404, got ${response.status}` };
                }
            },
            {
                category: 'Error Handling',
                name: 'Unauthorized Access',
                test: async () => {
                    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/board/${TEST_CONFIG.testBoardId}/export`);
                    return response.status === 401 ?
                        { success: true, details: 'Proper 401 error returned' } :
                        { success: false, details: `Expected 401, got ${response.status}` };
                }
            },
            {
                category: 'Error Handling',
                name: 'Invalid File Type',
                test: async () => {
                    const mockInvalidBlob = new Blob(['invalid data'], { type: 'application/octet-stream' });
                    const formData = new FormData();
                    formData.append('file', mockInvalidBlob, 'invalid-file.bin');
                    formData.append('type', 'image');
                    
                    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/board/${TEST_CONFIG.testBoardId}/import`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    return response.status === 400 ?
                        { success: true, details: 'Proper 400 error returned' } :
                        { success: false, details: `Expected 400, got ${response.status}` };
                }
            },
            
            // Performance Tests
            {
                category: 'Performance',
                name: 'Export Performance',
                test: async () => {
                    const startTime = Date.now();
                    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/board/${TEST_CONFIG.testBoardId}/export?format=png`);
                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    
                    return response.ok && duration < 5000 ?
                        { success: true, details: `Completed in ${duration}ms` } :
                        { success: false, details: `Too slow: ${duration}ms` };
                }
            },
            {
                category: 'Performance',
                name: 'Import Performance',
                test: async () => {
                    const mockBlob = new Blob(['test data'], { type: 'text/plain' });
                    const formData = new FormData();
                    formData.append('file', mockBlob, 'test.txt');
                    formData.append('type', 'json');
                    
                    const startTime = Date.now();
                    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/board/${TEST_CONFIG.testBoardId}/import`, {
                        method: 'POST',
                        body: formData
                    });
                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    
                    return duration < 3000 ?
                        { success: true, details: `Completed in ${duration}ms` } :
                        { success: false, details: `Too slow: ${duration}ms` };
                }
            }
        ];

        // UI Functions
        function createTestSection(category) {
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = `
                <h3>📋 ${category}</h3>
                <div id="${category.replace(/\s+/g, '-').toLowerCase()}-tests"></div>
            `;
            return section;
        }

        function createTestItem(test, result = null) {
            const item = document.createElement('div');
            item.className = `test-item ${result ? (result.success ? 'pass' : 'fail') : 'running'}`;
            
            const status = result ? (result.success ? '✅' : '❌') : '⏳';
            const statusText = result ? (result.success ? 'PASS' : 'FAIL') : 'RUNNING';
            
            item.innerHTML = `
                <div class="test-status">${status}</div>
                <div class="test-name">${test.name}</div>
                <div class="test-details">${result ? result.details : 'Running test...'}</div>
            `;
            
            return item;
        }

        function updateProgress(current, total) {
            const progress = (current / total) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        function updateSummary() {
            document.getElementById('totalTests').textContent = testResults.total;
            document.getElementById('passedTests').textContent = testResults.passed;
            document.getElementById('failedTests').textContent = testResults.failed;
            document.getElementById('successRate').textContent = 
                `${((testResults.passed / testResults.total) * 100).toFixed(1)}%`;
            
            document.getElementById('summary').style.display = 'block';
        }

        // Test Runner
        async function runTests() {
            // Reset results
            testResults.total = 0;
            testResults.passed = 0;
            testResults.failed = 0;
            testResults.errors = [];
            
            // Clear previous results
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            
            // Group tests by category
            const categories = [...new Set(tests.map(test => test.category))];
            const testResultsContainer = document.getElementById('testResults');
            
            // Create sections for each category
            const sections = {};
            categories.forEach(category => {
                const section = createTestSection(category);
                testResultsContainer.appendChild(section);
                sections[category] = section.querySelector(`#${category.replace(/\s+/g, '-').toLowerCase()}-tests`);
            });
            
            // Run tests
            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                const section = sections[test.category];
                const testItem = createTestItem(test);
                section.appendChild(testItem);
                
                updateProgress(i + 1, tests.length);
                
                try {
                    const result = await test.test();
                    testItem.className = `test-item ${result.success ? 'pass' : 'fail'}`;
                    testItem.innerHTML = `
                        <div class="test-status">${result.success ? '✅' : '❌'}</div>
                        <div class="test-name">${test.name}</div>
                        <div class="test-details">${result.details}</div>
                    `;
                    
                    testResults.total++;
                    if (result.success) {
                        testResults.passed++;
                    } else {
                        testResults.failed++;
                        testResults.errors.push({ name: test.name, details: result.details });
                    }
                } catch (error) {
                    testItem.className = 'test-item fail';
                    testItem.innerHTML = `
                        <div class="test-status">❌</div>
                        <div class="test-name">${test.name}</div>
                        <div class="test-details">Error: ${error.message}</div>
                    `;
                    
                    testResults.total++;
                    testResults.failed++;
                    testResults.errors.push({ name: test.name, details: error.message });
                }
                
                // Small delay to show progress
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            updateSummary();
            
            // Show final result
            if (testResults.failed === 0) {
                alert('🎉 All Phase 3 features are working correctly!');
            } else {
                alert(`⚠️ ${testResults.failed} tests failed. Check the results below.`);
            }
        }

        // Event Listeners
        document.getElementById('runTests').addEventListener('click', runTests);
        document.getElementById('clearResults').addEventListener('click', () => {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
        });
    </script>
</body>
</html> 